## 实验任务：
+ 保真度实验：
  + [x] 加入/不加入水印时的精度对比 
  + 固定水印bit数，改变人数
  + [x] 固定人数，改变水印bit数
+ 检测率实验：
  + [x] 交给别人检测时，能不能检测出来 **（最后一轮的数据，导出在excel了）**
    + [x] 画一个热力图那样，自己检测自己是1，检测别人的水印就在0.5左右，这个结合bits多少来做
  + 对比存在全局模型聚合操作的水印方案 (FedRep)
    + 画一个热力图那样，可以检测出其他人的水印
  + [x] 不同人数，不同bit长度的检测率对比 
    + 随着bit长度增加，检测率下降，但是下降的更少，且人数不影响检测率(FedRep)
+ 攻击实验
  + [x] 对head进行微调、剪枝
    + [x] 画水印检测率的图、精度图
+ [x] 增加noniid设置 
+ 调整水印层数，增加head层数
+ [x] 减少bits长度，对比检测率
+ 对比存在全局模型聚合操作的水印方案 (FedRep)
  
## 论文阅读：
+ Embedding Watermarks into Deep Neural Networks
+ Exploiting Shared Representations for Personalized Federated Learning
  + 实验是基于以上两篇论文的代码做的
+ FedIPR: Ownership Verification for Federated Deep Neural Network Models
  + 对比论文
+ DeepIPR: Deep Neural Network Ownership Verification With Passports
  + 混淆攻击，后面看能不能抵御

## 实验参数确定

--dataset cifar10 
--model cnn 
--num_classes 10 
--epochs 100 
--alg fedrep 
--lr 0.01
--num_users 100 
--gpu 0 
--shard_per_user 2 
--test_freq 1
--local_ep 11 
--frac 0.1 
--local_rep_ep 1 
--local_bs 10

改变的参数
--use_watermark [True,False]
--embed_dim [64,128,192,256,320,384,448]
--scale 0.1
--frac [0.1,0.2,0.3]

**ck: noniid 参数**

  -- datadir 数据文件夹
  -- beta  dirichlet distribution分布参数
  -- num_classes 作废,partition_data 会根据数据集确定
  -- partition 划分的形式 (homo noniid-labeldir noniid-#label iid-diff-quantity mixed)

## 实验问题：

#### noniid 修改后acc大幅下降

解决: 划分函数是随机划分标签，一个client的训练集和测试集应该是同种标签分配。修改划分函数，同时返回训练集和测试集的划分。

#### 剪枝方法

在 Torch 中，`torch.nn.utils.prune` 模块提供了多种剪枝方法和功能。以下是这个模块中常用的剪枝函数：

1. `torch.nn.utils.prune.ln_structured(x, name=None, amount=0.5, n=2, dim=0)`: L_n结构化剪枝。将维度dim的所有元素L_n标准化后按比例amount删除最小的n%。

2. `torch.nn.utils.prune.random_unstructured(x, name=None, amount=0.5)`: 随机剪枝。随机删除给定张量x中具有较小幅值的参数。

3. `torch.nn.utils.prune.l1_unstructured(x, name=None, amount=0.5)`: L1非结构化剪枝。按比例amount删除x中绝对值最小的参数。


4. `torch.nn.utils.prune.global_unstructured(x, pruning_fn, parameters, default=None)`: 全局非结构剪枝。将x中所有元素应用pruning_fn函数，该函数采用当前参数和default作为输入。

5. `torch.nn.utils.prune.remove(module, name)`: 移除指定名称的剪枝参数。

#### epochs=50/100 剪枝的效果不变

head 没有区分epochs，所以剪枝的时候，不管是50还是100，都是一样的

#### clients抽样问题

FedIPR采用的是不抽样，每轮只训练指定的clients。这样便于验证水印。
因为水印问题是考虑对参与模型训练的clients进行产权保护，所以可以只关注参与的clients